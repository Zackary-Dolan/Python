#-------------------------------------
from sklearn.tree import DecisionTreeClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix, accuracy_score
import pandas as pd


class Quali_Machine_Learning:

    def __init__(self, csv_file='qualifying.csv'):
        # Load the dataset
        self.df = pd.read_csv(csv_file)

        # Convert lap times safely
        for col in ['q1', 'q2', 'q3']:
            self.df[col] = self.df[col].apply(self.safe_lap_to_seconds)

        # Create target: top 10 positions = 1, others = 0
        self.df["Target"] = (self.df["position"] <= 10).astype(int)

        # Features: drop Target and position (position is derived)
        self.X = self.df.drop(['Target', 'position'], axis='columns')
        self.Y = self.df['Target']

        # Seed for reproducibility
        self.seedValue = 1

        # Train/test placeholders
        self.X_train = None
        self.X_test = None
        self.Y_train = None
        self.Y_test = None

        # Initialize Decision Tree
        self.tree = DecisionTreeClassifier()
        self.Y_hat = None
        self.cm = None

        print("Target column added and lap times converted.")

    def safe_lap_to_seconds(self, t):
        """Convert lap time from 'm:ss.sss' to seconds, handle missing values."""
        if pd.isna(t) or t == '':
            return 0.0
        t = str(t).strip()
        if ':' in t:
            try:
                mins, secs = t.split(':')
                return int(mins) * 60 + float(secs)
            except ValueError:
                # Handle bad format
                return 0.0
        else:
            return float(t)

    def updateSeed(self, newValue):
        self.seedValue = newValue

    def trainData(self, test_fraction=0.2):
        """Split the data and train the decision tree."""
        self.X_train, self.X_test, self.Y_train, self.Y_test = train_test_split(
            self.X, self.Y, test_size=test_fraction,
            random_state=self.seedValue, stratify=self.Y
        )

        self.tree.fit(self.X_train, self.Y_train)
        print("Decision Tree trained successfully.")

    def makePrediction(self, driverId, constructorId, number, q1, q2, q3):
        """Predict top-10 qualifying using provided data."""
        # Convert lap times
        q1 = self.safe_lap_to_seconds(q1)
        q2 = self.safe_lap_to_seconds(q2)
        q3 = self.safe_lap_to_seconds(q3)

        input_data = [[driverId, constructorId, number, q1, q2, q3]]
        df2 = pd.DataFrame(input_data, columns=['driverId', 'constructorId', 'number', 'q1', 'q2', 'q3'])

        return self.tree.predict(df2)[0]

    def testData(self):
        """Test the model on the held-out test set."""
        self.Y_hat = self.tree.predict(self.X_test)

        accuracy = accuracy_score(self.Y_test, self.Y_hat)
        cm = confusion_matrix(self.Y_test, self.Y_hat)

        print("Accuracy:", accuracy)
        print("Confusion Matrix:\n", cm)

        return cm, accuracy

    def readCategories(self):
        """Return string representation of categories."""
        result = ''
        index = 0
        setOfCategories = set(self.Y)
        for catName in sorted(setOfCategories):
            if index > 0:
                result += " / "
            if catName == 0:
                result += "Did not qualify top 10"
            if catName == 1:
                result += "Qualified top 10"
            index += 1
        return result
